{"title":"Adherencia HM en el Centro de Simulación","markdown":{"yaml":{"title":"Adherencia HM en el Centro de Simulación","subtitle":"Tasa de cumplimiento de la higiene de manos","author":[{"name":"Mario Camacho","affiliation":"Facultad de Medicina"},{"name":"Fernando Neria","affiliation":"Facultad de Medicina"}],"date":"2026-01-07","date-modified":"last-modified","output":{"html_document":{"toc-title":"Ingesta de datos","toc":true,"toc_depth":2}}},"headingText":"Ocupa todo el ancho del chunk","containsRefs":false,"markdown":"\n<button id=\"scroll-top\" onclick=\"window.scrollTo({top: 0, behavior: 'smooth'});\">\n  ↑ Inicio\n</button>\n- [Inicio](../index.html)\n- [Ingesta de datos](00_main.html)\n- [Resumen y gráficos descriptivos](01_eda.html)\n- [Análisis de la tasa de éxito en higiene de manos](02_estudio_adherencia.html)\n\n\n```{r Set up, include=FALSE}\nwd <- \"C:/Users/mario.camacho/OneDrive - UFV/Hospitales CAM\"\nwd <- file.path(wd, \"Sureste/Bea Isidoro 202511/20251118 Adherencia Higiene Manos en Centro de Simulación Clínica\")\nsetwd(wd)                       # cambia el WD de la sesión\nknitr::opts_knit$set(root.dir = wd)  # mantiene el WD en todos los chunks al render\nsource('scr/zz_libraries.R')\nsource('scr/zz_funciones.R')\noptions(error = NULL)  # Resetear manejo de errores\noptions(warning = NULL)  # Resetear manejo de warnings\n\nknitr::opts_chunk$set(echo = FALSE)\nknitr::opts_chunk$set(comment = NA)\noptions(tibble.width = Inf)\nknitr::opts_chunk$set(\n  out.width = \"120%\",\n  echo = FALSE,\n  comment = NA,\n  fig.width = 6,\n  fig.height = 4,\n  fig.align = \"center\",\n  fig.show = \"hold\"\n)\n\n# Espaciado entre imágenes en HTML\ncat(\"<style>img { margin-bottom: 20px; }</style>\")\n\noptions(skimr.max_char = 100) # Para que no trunque los nombres de los factores\n\ndata_rda <- readRDS(\"raw/data.RDA\")\ndata <- data_rda$data\ndata_raw <- data_rda$data_raw\n\ndata <- data |> mutate(accion = factor(if_else(accion=='No HM', 0, 1)))\ndata <- data |> mutate(tiempo = factor(if_else(str_detect(curso, \"pre\"), 'pre-formación', 'post-formación')))\n\nic_exacto_clopper_Pearson <- function(x, n, alpha = 0.05) {\n  ic_CP <- binom.test(x, n, conf.level = 1 - alpha)\n  return(c(x/n, ic_CP$conf.int))\n}\n\n```\n```{r Categorizar p-valor, include=FALSE}\ncategorizar_p <- function(p) {\n  if (is.na(p)) {\n    NA_character_\n  } else if (p < 0.001) {\n    \"<0.001\"\n  } else if (p < 0.01) {\n    \"<0.01\"\n  } else if (p < 0.05) {\n    \"<0.05\"\n  } else if (p < 0.1) {\n    \"<0.1\"\n  } else {\n    sprintf(\"%.3f\", p)\n  }\n}\n\n```\n```{r Bonferroni funcion, include=FALSE}\ncomparar_pares <- function(tabla_contingencia, alpha=0.05) {\n  niveles <- rownames(tabla_contingencia)\n  n_pares <- choose(length(niveles), 2)\n  resultados <- data.frame()\n  \n  for(i in 1:(length(niveles)-1)) {\n    for(j in (i+1):length(niveles)) {\n      # Crear subtabla para el par\n      subtabla <- tabla_contingencia[c(i, j), colnames(tabla_contingencia) != \"n\"]\n      prueba <- prop.test(subtabla, alternative = 'two.sided')\n      \n      resultados <- rbind(resultados, data.frame(\n        `Grupo 1` = niveles[i],\n        `Grupo 2` = niveles[j],\n        `n 1` = tabla_contingencia[c(i, j),][1,\"n\"],\n        `n 2` = tabla_contingencia[c(i, j),][2,\"n\"],\n        `Tasa cumplimiento 1` = round(subtabla[1, \"1\"]/sum(subtabla[1, ]), 3),\n        `Tasa cumplimiento 2` = round(subtabla[2, \"1\"]/sum(subtabla[2, ]), 3),\n        Diferencia = round(subtabla[1, \"1\"]/sum(subtabla[1, ]) - subtabla[2, \"1\"]/sum(subtabla[2, ]), 3),\n        # p_valor = prueba$p.value,\n        `p valor` = categorizar_p(p.adjust(prueba$p.value, method = \"bonferroni\", n = n_pares))\n        # Significativo = ifelse(prueba$p.value < alpha, ifelse(p.adjust(prueba$p.value, method = \"bonferroni\", n = n_pares) < alpha, \"*\", \"\"), \"\")\n        , check.names = FALSE\n      ))\n    }\n  }\n  return(resultados)\n}\n\n```\n```{r Gráfico de barras de la tasa de cumplimiento e IC 95 %, include=FALSE}\nplot_p3 <- function(ics) {\n  \n  ics$Curso <- factor(rownames(ics), levels = rownames(ics))\n  \n  p3 <-\n    ggplot(ics, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n    geom_col(fill = \"steelblue\", width = 0.7) +\n    geom_errorbar(\n      data = ics,\n      aes(x = Curso, ymin = `IC 95 % inf`, ymax = `IC 95 % sup`),\n      width = 0.15,\n      inherit.aes = FALSE\n    ) +\n    geom_point(\n      data = ics,\n      aes(x = Curso, y = `Tasa de cumplimiento`),\n      size = 2,\n      inherit.aes = FALSE\n    ) +\n    geom_text(\n      aes(label = paste0(round(`Tasa de cumplimiento` * 100, 1), \"%\")),\n      vjust = -0.5,\n      hjust = 1.5,\n      size = 3\n    ) +\n    geom_text(\n      aes(label = paste0(\"n = \", n), y = 0),\n      # color='white',\n      vjust = 1.2,\n      hjust = 0.5,\n      size = 2\n    ) +\n    labs(\n      x = \"Curso\",\n      y = \"Tasa de cumplimiento\",\n      title = \"Tasa de cumplimiento de higiene de manos e IC del 95 %\"\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(),\n      # limits = c(0, max(ics$`IC 95 % sup`, na.rm = TRUE) * 1.2)\n      limits = c(0, 0.60)\n    ) +\n    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n    theme_minimal() +\n    theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n  \n  return(p3)\n}\n```\n\n# Tasa de cumplimiento de HM por curso\n\n```{r include=FALSE}\ntabla_tasa_cumpl <- table(data$curso, data$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n```\n```{r include=TRUE}\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n  # column_spec(1:ncol(ics), width = \"auto\")  # columnas ajustadas al contenido\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por curso.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl aumento del cumplimiento de la higiene de manos entre pre y post-corto es significativo.  \nLa diferencia entre post-corto y post-largo es significativa, lo que sugiere que el efecto de la formación se disipa.  \nAun así, el cambio entre pre y post-largo sigue siendo significativo, por lo que **parece** que la formación tiene efecto a **nivel global** en la adherencia a la higiene de manos.\n:::\n\n```{r}\np1 <-\n  ggplot(tasa_cumplimiento, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_col(fill = \"steelblue\", width = 0.7) +\n  geom_text(\n    aes(label = paste0(round(tasa_cumplimiento * 100, 1), \"%\")),\n    vjust = -0.5\n  ) +\n  labs(\n    x = \"Curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Tasa de cumplimiento de higiene de manos por curso\"\n  ) +\n  ylim(0, max(tasa_cumplimiento$tasa_cumplimiento) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     # limits = c(0, max(tasa_cumplimiento$tasa_cumplimiento) * 1.2)\n                     limits = c(0, 0.60)) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n\nics$Curso <- factor(rownames(ics), levels = rownames(ics))\np2 <-\nggplot(ics, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_point(size = 2) +\n  geom_errorbar(aes(ymin = `IC 95 % inf`, ymax = `IC 95 % sup`), \n                width = 0.1) +\n  labs(x = \"Curso\", y = \"Tasa de cumplimiento de HM\", \n       title = \"Tasa de cumplimiento de la HM con IC del 95 %\") +\n  ylim(0, max(ics$`Tasa de cumplimiento`) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     # limits = c(0, max(ics$`IC 95 % sup`) * 1.2)\n                     limits = c(0, 0.60)) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n# grid::grid.newpage()\n# grid::grid.draw(p1 + p2 + patchwork::plot_layout(ncol = 2))\n\np3 <-\n  ggplot(tasa_cumplimiento, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_col(fill = \"steelblue\", width = 0.7) +\n  geom_errorbar(\n    data = ics,\n    aes(x = Curso, ymin = `IC 95 % inf`, ymax = `IC 95 % sup`),\n    width = 0.15,\n    inherit.aes = FALSE\n  ) +\n  geom_point(\n    data = ics,\n    aes(x = Curso, y = `Tasa de cumplimiento`),\n    size = 2,\n    inherit.aes = FALSE\n  ) +\n  geom_text(\n    aes(label = paste0(round(tasa_cumplimiento * 100, 1), \"%\")),\n    vjust = -0.5,\n    hjust = 1.4\n  ) +\n  labs(\n    x = \"Curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Tasa de cumplimiento de higiene de manos con IC del 95 %\"\n  ) +\n  ylim(0, max(ics$`Tasa de cumplimiento`) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     limits = c(0, max(ics$`IC 95 % sup`) * 1.2)\n                     # limits = c(0, 0.60)\n                     ) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n\np3 <- plot_p3(ics)\nknitr::knit_print(p3)\n```\n\n# Tasa de cumplimiento de HM por curso (filtrado por escenario)\n::: {.callout-tip}\nEl único escenario donde tiene sentido medir la trazabilidad del efecto a corto y largo plazo es en el escenario Consulta.\n:::\n\n```{r}\nresults <- readRDS(\"raw/results_curso_escenario.rds\")\nprint(results[[1]]$plot)\n\n\ntabla_tasa_cumpl <- table(data$escenario, data$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n```\n```{r include=TRUE}\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento por tipo de escenario e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n# column_spec(1:ncol(ics), width = \"auto\")  # columnas ajustadas al contenido\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por escenario.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption=\"Test de proporciones entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl procedimiento invasivo solo aparece en 5º (post-largo), representa un tercio de las oportunidades de higiene de manos y, además, tiene una alta adherencia (~46 %).\n:::\n::: {.callout-important}\nSe vuelve a comparar la tasa de cumplimiento de la HM entre cursos **sin** el escenario de procedimiento invasivo.\n:::\n\n```{r}\ntabla_tasa_cumpl <- table(data[data$escenario!='Procedimiento invasivo',]$curso, data[data$escenario!='Procedimiento invasivo',]$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por curso.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento (sin el escenario de procedimiento invasivo)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl aumento del cumplimiento de la higiene de manos entre pre y post-corto sigue siendo significativo.  \nLa diferencia entre post-corto y post-largo sigue siendo  significativa, lo que sugiere que el efecto de la formación se disipa.  \nPERO el cambio entre pre y post-largo no es significativo para una confianza del 95 %, por lo que la formación tiene **no tiene efecto** a largo plazo en la adherencia a la higiene de manos si no contamos con el escanario de procedimiento invasivo.\n:::\n\n```{r}\np3 <- plot_p3(ics)\nknitr::knit_print(p3)\n```\n\nSeguimos con las comparaciones de tasa de adherencia por escenario.\n\n::: {.callout-note}\n**Box**\n\n```{r}\ndata_esc <- subset(data, escenario == 'Box')\ntabla_tasa_cumpl <- table(data_esc$curso, data_esc$accion)\ntabla_tasa_cumpl <- tabla_tasa_cumpl[rowSums(tabla_tasa_cumpl) > 1, ]\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl, 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento en el escenario BOX con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\nCalculamos la diferencia de la tasa de cumplimiento y obtenemos el p-valor ajustado por Bonferroni.\n\n```{r}\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento en el escenario BOX\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\np3 <- plot_p3(ics) + labs(subtitle = \"Escenario: Box\")\nknitr::knit_print(p3)\n```\n\n:::\n::: {.callout-note}\n**Consulta**\n\n```{r}\ndata_esc <- subset(data, escenario == 'Consulta')\ntabla_tasa_cumpl <- table(data_esc$curso, data_esc$accion)\ntabla_tasa_cumpl <- tabla_tasa_cumpl[rowSums(tabla_tasa_cumpl) > 1, ]\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl, 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento en el escenario Consulta con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\nCalculamos la diferencia de la tasa de cumplimiento y obtenemos el p-valor ajustado por Bonferroni.\n\n```{r}\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones en el escenario Consulta entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\np3 <- plot_p3(ics) + labs(subtitle = \"Escenario: Consulta\")\nknitr::knit_print(p3)\n```\n\n:::\n# Análisis de la proporción de acciones por curso, según indicación y escenario\n- Para cada indicación de higiene de manos se muestra el número de oportunidades total y por curso.  \n- Se incluye el número de oportunidades aprovechas en cada curso y la tasa de cumplimiento que representan.  \n- La comparación de las tasas de cumplimiento entre los cursos (grupos independientes) se realiza a través de pruebas no paramétricas Chi-cuadrado o test exacto de Fisher.  \n- Un p-valor bajo indica evidencia estadísticamente significativa para no aceptar la hipótesis nula: existe evidencia de que la tasa de cumplimiento entre al menos dos de los grupos es diferente, según los datos recogidos.  \n\n```{r}\n# tbl_strata(data, strata = indicacion, .tbl_fun = \n#              ~ .x |>\n#              tbl_summary(by = curso, missing = \"no\", value = list(accion~1), percent = 'row', include = c(accion)) |>\n#              add_n() |> add_p())\n\nres <- split(data, data$indicacion) |>\n  map(~ .x |>\n        tbl_summary(\n          by = curso,\n          missing = \"no\",\n          value = list(accion ~ 1),\n          percent = \"cell\",\n          include = accion\n        ) |>\n        add_n() |>\n        add_p()\n  )\n\ncat(paste0(\"Momento de Higiene de manos M1 (\", res$M1$table_body$n, \" oprtunidades).\\n\"))\nres$M1\ncat(paste0(\"Momento de Higiene de manos M2 (\", res$M2$table_body$n, \" oprtunidades).\\n\"))\nres$M2\ncat(paste0(\"Momento de Higiene de manos M3 (\", res$M3$table_body$n, \" oprtunidades).\\n\"))\nres$M3\ncat(paste0(\"Momento de Higiene de manos M4 (\", res$M4$table_body$n, \" oprtunidades).\\n\"))\nres$M4\ncat(paste0(\"Momento de Higiene de manos M5 (\", res$M5$table_body$n, \" oprtunidades).\\n\"))\nres$M5\n```\n\n# Análisis de la proporción de acciones por escenario, según indicación y curso\n- Para cada indicación de higiene de manos se muestra el número de oportunidades total y por escenario  \n- Se incluye el número de oportunidades aprovechas en cada escenario y la tasa de cumplimiento que representan.  \n- La comparación de las tasas de cumplimiento entre los cursos (grupos independientes) se realiza a través de pruebas no paramétricas Chi-cuadrado o test exacto de Fisher.  \n- Un p-valor bajo indica evidencia estadísticamente significativa para no aceptar la hipótesis nula: existe evidencia de que la tasa de cumplimiento entre al menos dos de los escenarios es diferente, según los datos recogidos.  \n\n```{r}\n# tbl_strata(data, strata = indicacion, .tbl_fun = \n#              ~ .x |>\n#              tbl_summary(by = curso, missing = \"no\", value = list(accion~1), percent = 'row', include = c(accion)) |>\n#              add_n() |> add_p())\n\nres <- split(data, data$escenario) |>\n  map(~ .x |>\n        tbl_summary(\n          by = curso,\n          missing = \"no\",\n          value = list(accion ~ 1),\n          percent = \"cell\",\n          include = accion\n        ) |>\n        add_n() |>\n        add_p()\n  )\n\ncat(paste0(\"Momento de Higiene de manos Box (\", res$Box$table_body$n, \" oprtunidades).\\n\"))\nres$Box\ncat(paste0(\"Momento de Higiene de manos Consulta (\", res$Consulta$table_body$n, \" oprtunidades).\\n\"))\nres$Consulta\ncat(paste0(\"Momento de Higiene de manos Procedimiento invasivo (\", res$`Procedimiento invasivo`$table_body$n, \" oprtunidades).\\n\"))\nres$`Procedimiento invasivo`\n```\n\n# Modelos\n\n```{r}\n# Nota MCM: comparar curso a curso: factor nominal.  \n# Nota MCM: comparar el efecto tiempo: factor ordinal.  \n```\n\n\nEfecto de curso, indicación y escenario sobre la higiene de manos.\n\n| Resultado   | Qué afirmar               |  \n| ----------- | ------------------------- |  \n| L ✔️ / Q ✔️ | Tendencia + curvatura     |  \n| L ✔️ / Q ❌  | Tendencia lineal          |  \n| L ❌ / Q ✔️  | Efecto no monótono        |  \n| L ❌ / Q ❌   | Sin asociación detectable |\n\n**Considerando el curso como ORDINAL para cuantificar el efecto tiempo** (no se trata como numérico ya que suponemos que no están igualmente espaciados).\n\n```{r}\nm1 <- glm(accion ~ curso + indicacion + escenario, data = data, family = binomial(link = 'logit'))\ntbl_regression(m1, exponentiate = FALSE)\n```\n\n::: {.callout-note}\nParámetros lineal y cuadrático del factor curso significativos: existe una tendencia global a lo largo de los niveles PERO esa tendencia  no es puramente lineal.  \n- El efecto del ordinal no puede resumirse en un único “por nivel”.  \n- Los cambios entre niveles no son constantes.  \n- Algún nivel intermedio se comporta de forma distinta a lo esperado por una recta.  \n:::\n\n```{r}\n# Modelo con curso como numérico (efecto lineal)\nm_lin <- glm(accion ~ as.numeric(curso) + indicacion + escenario, data = data, family = binomial(link = \"logit\"))\n\n# Modelo con curso como factor (categórico)\nm_fac <- glm(accion ~ factor(curso) + indicacion + escenario, data = data, family = binomial(link = \"logit\"))\n\ncat(\"H0: el efecto de curso es lineal (modelo numérico es suficiente).\\nH1: el efecto no es lineal (modelo categórico ajusta mejor). \")\nlrt <- anova(m_lin, m_fac, test = \"LRT\")\nlrt <- broom::tidy(lrt, conf.int = FALSE)\nlrt <- lrt |> as.data.frame() |> mutate(`p valor` = sapply(p.value, categorizar_p))\nkable(lrt |> select(-p.value), format = \"html\", caption = \"Prueba de razón de verosimilitud (LRT) para evaluar la linealidad del efecto de curso\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\ncat(ifelse(lrt$p.value[2] < 0.05,\n           \"Se rechaza H0 (p < 0.05): el efecto de curso no es lineal y conviene tratarlo como factor.\\n\",\n           \"No hay evidencia para rechazar H0 (p ≥ 0.05): no hay evidencia contra la linealidad del efecto de curso.\\n\"))\n\ncat(\"Visualización del patrón no lineal.\")\nnewdata <- data.frame(\n  curso = sort(unique(data |> pull(curso))),\n  indicacion = levels(data |> pull(indicacion))[1],\n  escenario  = levels(data |> pull(escenario))[1])\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"response\"),\n    p_fac = predict(m_fac, newdata, type = \"response\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Probabilidad predicha por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"topleft\",\n  # inset = c(0, -0),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"link\"),\n    p_fac = predict(m_fac, newdata, type = \"link\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Logit por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"topleft\",\n  # inset = c(0, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n\n# Si los puntos negros siguen aproximadamente una recta: el modelo lineal es razonable.  \n# Si existen saltos, curvatura o patrones: el supuesto lineal falla.  \n# La línea roja es lo que el modelo lineal fuerza a que pase.  \n```\n\n\n::: {.callout-note}\n- Los parámetros lineal y cuadrático del factor curso son significativo.  \n- El test LRT rechaza la hipótesis nula.  \n- La relación entre curso y la probabilidad predicha presenta diferencias por curso.\n\nHay evidencia de una relación no lineal entre el curso y la tasa de cumplimiento de higiene de manos.  \nPor ello, no es apropiado usar odd ratios como medidas de interpretación del efecto, se recomiendo usar las medias marginales estimadas.  \n(*emmeans: \"¿Cuál es el riesgo en cada nivel específico del curso y cómo difieren entre sí?*\")\n:::\n\n```{r}\ncat(\"Medias marginales estimadas (probabilidad).\")\ncomparaciones <- emmeans::emmeans(m1, ~ curso, type = \"response\")\n\nkable(comparaciones, format = \"html\", caption = \"Medias marginales estimadas (probabilidad)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\ncat(\"Comparaciones entre cursos.\")\n# (Tukey, escala log-odds)\ncomparaciones <- emmeans::contrast(emmeans::emmeans(m1, ~ curso), method = \"pairwise\")\ncomparaciones <- as.data.frame(comparaciones)\ncomparaciones$`p valor` <- vapply(comparaciones$p.value, categorizar_p, character(1))\n\nkable(comparaciones |> select(-'p.value'), format = \"html\", caption = \"Comparaciones pareadas entre niveles de curso usando estimaciones marginales\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n\nTip. Si estimate > 0: primer grupo tiene mayor media. Si estimate < 0: segundo grupo tiene mayor media.  \n- **pre vs post-corto**. Diferencia negativa (post-corto > pre): la tasa aumenta a corto plazo pero no es significativo.  \n- **pre vs post-largo**. Diferencia positiva (post-largo < pre): la tasa disminuye a largo plazo pero no es significativo.  \n- **post-corto vs post-largo**. Diferencia positiva (post-largo < post-corto), la tasa disminuye con el tiempo en los cursos post-formación y la disminución sí es significativa.  \n\n\n```{r}\nemm <- emmeans::emmeans(m1, ~ curso)\nemm <- as.data.frame(emm)\nggplot(emm, aes(x = curso, y = emmean)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +\n  geom_line(aes(group = 1), linetype = \"dashed\") +\n  labs(\n    x = \"Nivel de curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Medias estimadas de acción por nivel de curso\",\n    subtitle = \"IC al 95 %\"\n  ) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n```\n\n\n::: {.callout-important}\nSe vuelve a estimar el efecto del curso en la tasa de cumplimiento **solo en el escenario de Consulta**.\n:::\n\n```{r}\nm2 <- glm(accion ~ curso + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = 'logit'))\ntbl_regression(m2, exponentiate = FALSE)\n\n# Modelo con curso como numérico (efecto lineal)\nm_lin <- glm(accion ~ as.numeric(curso) + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = \"logit\"))\n\n# Modelo con curso como factor (categórico)\nm_fac <- glm(accion ~ factor(curso) + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = \"logit\"))\n\ncat(\"H0: el efecto de curso es lineal (modelo numérico es suficiente).\\nH1: el efecto no es lineal (modelo categórico ajusta mejor). \")\nlrt <- anova(m_lin, m_fac, test = \"LRT\")\nlrt <- broom::tidy(lrt, conf.int = FALSE)\nlrt <- lrt |> as.data.frame() |> mutate(`p valor` = sapply(p.value, categorizar_p))\nkable(lrt |> select(-p.value), format = \"html\", caption = \"Prueba de razón de verosimilitud (LRT) para evaluar la linealidad del efecto de curso\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\ncat(ifelse(lrt$p.value[2] < 0.05,\n           \"Se rechaza H0 (p < 0.05): el efecto de curso no es lineal y conviene tratarlo como factor.\\n\",\n           \"No hay evidencia para rechazar H0 (p ≥ 0.05): no hay evidencia contra la linealidad del efecto de curso.\\n\"))\n\ncat(\"Visualización del patrón no lineal.\")\nnewdata <- data.frame(\n  curso = sort(unique(data |> filter(escenario=='Consulta') |> pull(curso))),\n  indicacion = levels(data |> filter(escenario=='Consulta') |> pull(indicacion))[1],\n  escenario  = levels(data |> filter(escenario=='Consulta') |> pull(escenario))[1])\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"response\"),\n    p_fac = predict(m_fac, newdata, type = \"response\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Probabilidad predicha por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"bottomleft\",\n  # inset = c(10, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  xpd = TRUE,\n  cex = 0.5\n)\n\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"link\"),\n    p_fac = predict(m_fac, newdata, type = \"link\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Logit por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"bottomleft\",\n  # inset = c(0, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n```\n\n\n::: {.callout-note}\n- Los parámetros lineal y cuadrático del factor curso son significativo.  \n- El test LRT rechaza la hipótesis nula.  \n- La relación entre curso y la probabilidad predicha presenta diferencias por curso.\n\nHay evidencia de una relación no lineal entre el curso y la tasa de cumplimiento de higiene de manos.  \nPor ello, no es apropiado usar odd ratios como medidas de interpretación del efecto, se recomiendo usar las medias marginales estimadas.  \n(*emmeans: \"¿Cuál es el riesgo en cada nivel específico del curso y cómo difieren entre sí?*\")\n:::\n\n```{r}\ncat(\"Medias marginales estimadas (probabilidad).\")\ncomparaciones <- emmeans::emmeans(m2, ~ curso, type = \"response\")\n\nkable(comparaciones, format = \"html\", caption = \"Medias marginales estimadas (probabilidad)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\ncat(\"Comparaciones entre cursos.\")\n# (Tukey, escala log-odds)\ncomparaciones <- emmeans::contrast(emmeans::emmeans(m2, ~ curso), method = \"pairwise\")\ncomparaciones <- as.data.frame(comparaciones)\ncomparaciones$`p valor` <- vapply(comparaciones$p.value, categorizar_p, character(1))\n\nkable(comparaciones |> select(-'p.value'), format = \"html\", caption = \"Comparaciones pareadas entre niveles de curso usando estimaciones marginales\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n\nTip. Si estimate > 0: primer grupo tiene mayor media. Si estimate < 0: segundo grupo tiene mayor media.  \n- **pre vs post-corto. Diferencia negativa (post-corto > pre): la tasa aumenta a corto plazo pero no es significativo.  \n- **pre vs post-largo**. Diferencia positiva (post-largo < pre): la tasa disminuye a largo plazo pero no es significativo.  \n- **post-corto vs post-largo**. Diferencia positiva (post-largo < post-corto), la tasa disminuye con el tiempo en los cursos post-formación y la disminución sí es significativa.  \n\n\n```{r}\nemm <- emmeans::emmeans(m2, ~ curso)\nemm <- as.data.frame(emm)\nggplot(emm, aes(x = curso, y = emmean)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +\n  geom_line(aes(group = 1), linetype = \"dashed\") +\n  labs(\n    x = \"Nivel de curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Medias estimadas de acción por nivel de curso\",\n    subtitle = \"IC al 95 %\"\n  ) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n```\n","srcMarkdownNoYaml":"\n<button id=\"scroll-top\" onclick=\"window.scrollTo({top: 0, behavior: 'smooth'});\">\n  ↑ Inicio\n</button>\n- [Inicio](../index.html)\n- [Ingesta de datos](00_main.html)\n- [Resumen y gráficos descriptivos](01_eda.html)\n- [Análisis de la tasa de éxito en higiene de manos](02_estudio_adherencia.html)\n\n\n```{r Set up, include=FALSE}\nwd <- \"C:/Users/mario.camacho/OneDrive - UFV/Hospitales CAM\"\nwd <- file.path(wd, \"Sureste/Bea Isidoro 202511/20251118 Adherencia Higiene Manos en Centro de Simulación Clínica\")\nsetwd(wd)                       # cambia el WD de la sesión\nknitr::opts_knit$set(root.dir = wd)  # mantiene el WD en todos los chunks al render\nsource('scr/zz_libraries.R')\nsource('scr/zz_funciones.R')\noptions(error = NULL)  # Resetear manejo de errores\noptions(warning = NULL)  # Resetear manejo de warnings\n\nknitr::opts_chunk$set(echo = FALSE)\nknitr::opts_chunk$set(comment = NA)\noptions(tibble.width = Inf)\n# Ocupa todo el ancho del chunk\nknitr::opts_chunk$set(\n  out.width = \"120%\",\n  echo = FALSE,\n  comment = NA,\n  fig.width = 6,\n  fig.height = 4,\n  fig.align = \"center\",\n  fig.show = \"hold\"\n)\n\n# Espaciado entre imágenes en HTML\ncat(\"<style>img { margin-bottom: 20px; }</style>\")\n\noptions(skimr.max_char = 100) # Para que no trunque los nombres de los factores\n\ndata_rda <- readRDS(\"raw/data.RDA\")\ndata <- data_rda$data\ndata_raw <- data_rda$data_raw\n\ndata <- data |> mutate(accion = factor(if_else(accion=='No HM', 0, 1)))\ndata <- data |> mutate(tiempo = factor(if_else(str_detect(curso, \"pre\"), 'pre-formación', 'post-formación')))\n\nic_exacto_clopper_Pearson <- function(x, n, alpha = 0.05) {\n  ic_CP <- binom.test(x, n, conf.level = 1 - alpha)\n  return(c(x/n, ic_CP$conf.int))\n}\n\n```\n```{r Categorizar p-valor, include=FALSE}\ncategorizar_p <- function(p) {\n  if (is.na(p)) {\n    NA_character_\n  } else if (p < 0.001) {\n    \"<0.001\"\n  } else if (p < 0.01) {\n    \"<0.01\"\n  } else if (p < 0.05) {\n    \"<0.05\"\n  } else if (p < 0.1) {\n    \"<0.1\"\n  } else {\n    sprintf(\"%.3f\", p)\n  }\n}\n\n```\n```{r Bonferroni funcion, include=FALSE}\ncomparar_pares <- function(tabla_contingencia, alpha=0.05) {\n  niveles <- rownames(tabla_contingencia)\n  n_pares <- choose(length(niveles), 2)\n  resultados <- data.frame()\n  \n  for(i in 1:(length(niveles)-1)) {\n    for(j in (i+1):length(niveles)) {\n      # Crear subtabla para el par\n      subtabla <- tabla_contingencia[c(i, j), colnames(tabla_contingencia) != \"n\"]\n      prueba <- prop.test(subtabla, alternative = 'two.sided')\n      \n      resultados <- rbind(resultados, data.frame(\n        `Grupo 1` = niveles[i],\n        `Grupo 2` = niveles[j],\n        `n 1` = tabla_contingencia[c(i, j),][1,\"n\"],\n        `n 2` = tabla_contingencia[c(i, j),][2,\"n\"],\n        `Tasa cumplimiento 1` = round(subtabla[1, \"1\"]/sum(subtabla[1, ]), 3),\n        `Tasa cumplimiento 2` = round(subtabla[2, \"1\"]/sum(subtabla[2, ]), 3),\n        Diferencia = round(subtabla[1, \"1\"]/sum(subtabla[1, ]) - subtabla[2, \"1\"]/sum(subtabla[2, ]), 3),\n        # p_valor = prueba$p.value,\n        `p valor` = categorizar_p(p.adjust(prueba$p.value, method = \"bonferroni\", n = n_pares))\n        # Significativo = ifelse(prueba$p.value < alpha, ifelse(p.adjust(prueba$p.value, method = \"bonferroni\", n = n_pares) < alpha, \"*\", \"\"), \"\")\n        , check.names = FALSE\n      ))\n    }\n  }\n  return(resultados)\n}\n\n```\n```{r Gráfico de barras de la tasa de cumplimiento e IC 95 %, include=FALSE}\nplot_p3 <- function(ics) {\n  \n  ics$Curso <- factor(rownames(ics), levels = rownames(ics))\n  \n  p3 <-\n    ggplot(ics, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n    geom_col(fill = \"steelblue\", width = 0.7) +\n    geom_errorbar(\n      data = ics,\n      aes(x = Curso, ymin = `IC 95 % inf`, ymax = `IC 95 % sup`),\n      width = 0.15,\n      inherit.aes = FALSE\n    ) +\n    geom_point(\n      data = ics,\n      aes(x = Curso, y = `Tasa de cumplimiento`),\n      size = 2,\n      inherit.aes = FALSE\n    ) +\n    geom_text(\n      aes(label = paste0(round(`Tasa de cumplimiento` * 100, 1), \"%\")),\n      vjust = -0.5,\n      hjust = 1.5,\n      size = 3\n    ) +\n    geom_text(\n      aes(label = paste0(\"n = \", n), y = 0),\n      # color='white',\n      vjust = 1.2,\n      hjust = 0.5,\n      size = 2\n    ) +\n    labs(\n      x = \"Curso\",\n      y = \"Tasa de cumplimiento\",\n      title = \"Tasa de cumplimiento de higiene de manos e IC del 95 %\"\n    ) +\n    scale_y_continuous(\n      labels = scales::percent_format(),\n      # limits = c(0, max(ics$`IC 95 % sup`, na.rm = TRUE) * 1.2)\n      limits = c(0, 0.60)\n    ) +\n    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n    theme_minimal() +\n    theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n  \n  return(p3)\n}\n```\n\n# Tasa de cumplimiento de HM por curso\n\n```{r include=FALSE}\ntabla_tasa_cumpl <- table(data$curso, data$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n```\n```{r include=TRUE}\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n  # column_spec(1:ncol(ics), width = \"auto\")  # columnas ajustadas al contenido\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por curso.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl aumento del cumplimiento de la higiene de manos entre pre y post-corto es significativo.  \nLa diferencia entre post-corto y post-largo es significativa, lo que sugiere que el efecto de la formación se disipa.  \nAun así, el cambio entre pre y post-largo sigue siendo significativo, por lo que **parece** que la formación tiene efecto a **nivel global** en la adherencia a la higiene de manos.\n:::\n\n```{r}\np1 <-\n  ggplot(tasa_cumplimiento, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_col(fill = \"steelblue\", width = 0.7) +\n  geom_text(\n    aes(label = paste0(round(tasa_cumplimiento * 100, 1), \"%\")),\n    vjust = -0.5\n  ) +\n  labs(\n    x = \"Curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Tasa de cumplimiento de higiene de manos por curso\"\n  ) +\n  ylim(0, max(tasa_cumplimiento$tasa_cumplimiento) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     # limits = c(0, max(tasa_cumplimiento$tasa_cumplimiento) * 1.2)\n                     limits = c(0, 0.60)) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n\nics$Curso <- factor(rownames(ics), levels = rownames(ics))\np2 <-\nggplot(ics, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_point(size = 2) +\n  geom_errorbar(aes(ymin = `IC 95 % inf`, ymax = `IC 95 % sup`), \n                width = 0.1) +\n  labs(x = \"Curso\", y = \"Tasa de cumplimiento de HM\", \n       title = \"Tasa de cumplimiento de la HM con IC del 95 %\") +\n  ylim(0, max(ics$`Tasa de cumplimiento`) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     # limits = c(0, max(ics$`IC 95 % sup`) * 1.2)\n                     limits = c(0, 0.60)) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n# grid::grid.newpage()\n# grid::grid.draw(p1 + p2 + patchwork::plot_layout(ncol = 2))\n\np3 <-\n  ggplot(tasa_cumplimiento, aes(x = Curso, y = `Tasa de cumplimiento`)) +\n  geom_col(fill = \"steelblue\", width = 0.7) +\n  geom_errorbar(\n    data = ics,\n    aes(x = Curso, ymin = `IC 95 % inf`, ymax = `IC 95 % sup`),\n    width = 0.15,\n    inherit.aes = FALSE\n  ) +\n  geom_point(\n    data = ics,\n    aes(x = Curso, y = `Tasa de cumplimiento`),\n    size = 2,\n    inherit.aes = FALSE\n  ) +\n  geom_text(\n    aes(label = paste0(round(tasa_cumplimiento * 100, 1), \"%\")),\n    vjust = -0.5,\n    hjust = 1.4\n  ) +\n  labs(\n    x = \"Curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Tasa de cumplimiento de higiene de manos con IC del 95 %\"\n  ) +\n  ylim(0, max(ics$`Tasa de cumplimiento`) * 1.2) +\n  scale_y_continuous(labels = scales::percent_format(),\n                     limits = c(0, max(ics$`IC 95 % sup`) * 1.2)\n                     # limits = c(0, 0.60)\n                     ) +\n  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 15)) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n\np3 <- plot_p3(ics)\nknitr::knit_print(p3)\n```\n\n# Tasa de cumplimiento de HM por curso (filtrado por escenario)\n::: {.callout-tip}\nEl único escenario donde tiene sentido medir la trazabilidad del efecto a corto y largo plazo es en el escenario Consulta.\n:::\n\n```{r}\nresults <- readRDS(\"raw/results_curso_escenario.rds\")\nprint(results[[1]]$plot)\n\n\ntabla_tasa_cumpl <- table(data$escenario, data$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n```\n```{r include=TRUE}\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento por tipo de escenario e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n# column_spec(1:ncol(ics), width = \"auto\")  # columnas ajustadas al contenido\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por escenario.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption=\"Test de proporciones entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl procedimiento invasivo solo aparece en 5º (post-largo), representa un tercio de las oportunidades de higiene de manos y, además, tiene una alta adherencia (~46 %).\n:::\n::: {.callout-important}\nSe vuelve a comparar la tasa de cumplimiento de la HM entre cursos **sin** el escenario de procedimiento invasivo.\n:::\n\n```{r}\ntabla_tasa_cumpl <- table(data[data$escenario!='Procedimiento invasivo',]$curso, data[data$escenario!='Procedimiento invasivo',]$accion)\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl[,c('0','1')], 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\n# Comparación por pares con corrección de Bonferroni\ncat(\"Comparamos la tasa de cumplimiento por curso.\\nCalculamos la diferencia de proporciones y obtenemos el p-valor ajustado por Bonferroni.\")\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento (sin el escenario de procedimiento invasivo)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n::: {.callout-tip}\nEl aumento del cumplimiento de la higiene de manos entre pre y post-corto sigue siendo significativo.  \nLa diferencia entre post-corto y post-largo sigue siendo  significativa, lo que sugiere que el efecto de la formación se disipa.  \nPERO el cambio entre pre y post-largo no es significativo para una confianza del 95 %, por lo que la formación tiene **no tiene efecto** a largo plazo en la adherencia a la higiene de manos si no contamos con el escanario de procedimiento invasivo.\n:::\n\n```{r}\np3 <- plot_p3(ics)\nknitr::knit_print(p3)\n```\n\nSeguimos con las comparaciones de tasa de adherencia por escenario.\n\n::: {.callout-note}\n**Box**\n\n```{r}\ndata_esc <- subset(data, escenario == 'Box')\ntabla_tasa_cumpl <- table(data_esc$curso, data_esc$accion)\ntabla_tasa_cumpl <- tabla_tasa_cumpl[rowSums(tabla_tasa_cumpl) > 1, ]\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl, 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento en el escenario BOX con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\nCalculamos la diferencia de la tasa de cumplimiento y obtenemos el p-valor ajustado por Bonferroni.\n\n```{r}\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones entre las tasas de cumplimiento en el escenario BOX\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\np3 <- plot_p3(ics) + labs(subtitle = \"Escenario: Box\")\nknitr::knit_print(p3)\n```\n\n:::\n::: {.callout-note}\n**Consulta**\n\n```{r}\ndata_esc <- subset(data, escenario == 'Consulta')\ntabla_tasa_cumpl <- table(data_esc$curso, data_esc$accion)\ntabla_tasa_cumpl <- tabla_tasa_cumpl[rowSums(tabla_tasa_cumpl) > 1, ]\nn <- rowSums(tabla_tasa_cumpl)\ntabla_tasa_cumpl <- cbind(tabla_tasa_cumpl, n = rowSums(tabla_tasa_cumpl))\ntasa_cumplimiento_niveles <- prop.table(tabla_tasa_cumpl[,c('0','1')], margin = 1)[, \"1\"]\ntasa_cumplimiento <- data.frame(Curso = factor(names(tasa_cumplimiento_niveles), levels = names(tasa_cumplimiento_niveles)),\n                                tasa_cumplimiento = as.numeric(tasa_cumplimiento_niveles))\n\nics <- t(apply(tabla_tasa_cumpl, 1, function(x) ic_exacto_clopper_Pearson(x[\"1\"], sum(x)))) |> as.data.frame()\ncolnames(ics) <- c(\"Tasa de cumplimiento\", \"IC 95 % inf\", \"IC 95 % sup\")\ncat(\"Tasas de cumplimiento e intervalos de confianza del 95%.\\n\")\n\nkable(round(ics, 3), format = \"html\", caption = \"Tasas de cumplimiento en el escenario Consulta con IC del 95%\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\nCalculamos la diferencia de la tasa de cumplimiento y obtenemos el p-valor ajustado por Bonferroni.\n\n```{r}\ncomparaciones <- comparar_pares(tabla_tasa_cumpl)\n\nkable(comparaciones, format = \"html\", caption = \"Test de proporciones en el escenario Consulta entre las tasas de cumplimiento\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\np3 <- plot_p3(ics) + labs(subtitle = \"Escenario: Consulta\")\nknitr::knit_print(p3)\n```\n\n:::\n# Análisis de la proporción de acciones por curso, según indicación y escenario\n- Para cada indicación de higiene de manos se muestra el número de oportunidades total y por curso.  \n- Se incluye el número de oportunidades aprovechas en cada curso y la tasa de cumplimiento que representan.  \n- La comparación de las tasas de cumplimiento entre los cursos (grupos independientes) se realiza a través de pruebas no paramétricas Chi-cuadrado o test exacto de Fisher.  \n- Un p-valor bajo indica evidencia estadísticamente significativa para no aceptar la hipótesis nula: existe evidencia de que la tasa de cumplimiento entre al menos dos de los grupos es diferente, según los datos recogidos.  \n\n```{r}\n# tbl_strata(data, strata = indicacion, .tbl_fun = \n#              ~ .x |>\n#              tbl_summary(by = curso, missing = \"no\", value = list(accion~1), percent = 'row', include = c(accion)) |>\n#              add_n() |> add_p())\n\nres <- split(data, data$indicacion) |>\n  map(~ .x |>\n        tbl_summary(\n          by = curso,\n          missing = \"no\",\n          value = list(accion ~ 1),\n          percent = \"cell\",\n          include = accion\n        ) |>\n        add_n() |>\n        add_p()\n  )\n\ncat(paste0(\"Momento de Higiene de manos M1 (\", res$M1$table_body$n, \" oprtunidades).\\n\"))\nres$M1\ncat(paste0(\"Momento de Higiene de manos M2 (\", res$M2$table_body$n, \" oprtunidades).\\n\"))\nres$M2\ncat(paste0(\"Momento de Higiene de manos M3 (\", res$M3$table_body$n, \" oprtunidades).\\n\"))\nres$M3\ncat(paste0(\"Momento de Higiene de manos M4 (\", res$M4$table_body$n, \" oprtunidades).\\n\"))\nres$M4\ncat(paste0(\"Momento de Higiene de manos M5 (\", res$M5$table_body$n, \" oprtunidades).\\n\"))\nres$M5\n```\n\n# Análisis de la proporción de acciones por escenario, según indicación y curso\n- Para cada indicación de higiene de manos se muestra el número de oportunidades total y por escenario  \n- Se incluye el número de oportunidades aprovechas en cada escenario y la tasa de cumplimiento que representan.  \n- La comparación de las tasas de cumplimiento entre los cursos (grupos independientes) se realiza a través de pruebas no paramétricas Chi-cuadrado o test exacto de Fisher.  \n- Un p-valor bajo indica evidencia estadísticamente significativa para no aceptar la hipótesis nula: existe evidencia de que la tasa de cumplimiento entre al menos dos de los escenarios es diferente, según los datos recogidos.  \n\n```{r}\n# tbl_strata(data, strata = indicacion, .tbl_fun = \n#              ~ .x |>\n#              tbl_summary(by = curso, missing = \"no\", value = list(accion~1), percent = 'row', include = c(accion)) |>\n#              add_n() |> add_p())\n\nres <- split(data, data$escenario) |>\n  map(~ .x |>\n        tbl_summary(\n          by = curso,\n          missing = \"no\",\n          value = list(accion ~ 1),\n          percent = \"cell\",\n          include = accion\n        ) |>\n        add_n() |>\n        add_p()\n  )\n\ncat(paste0(\"Momento de Higiene de manos Box (\", res$Box$table_body$n, \" oprtunidades).\\n\"))\nres$Box\ncat(paste0(\"Momento de Higiene de manos Consulta (\", res$Consulta$table_body$n, \" oprtunidades).\\n\"))\nres$Consulta\ncat(paste0(\"Momento de Higiene de manos Procedimiento invasivo (\", res$`Procedimiento invasivo`$table_body$n, \" oprtunidades).\\n\"))\nres$`Procedimiento invasivo`\n```\n\n# Modelos\n\n```{r}\n# Nota MCM: comparar curso a curso: factor nominal.  \n# Nota MCM: comparar el efecto tiempo: factor ordinal.  \n```\n\n\nEfecto de curso, indicación y escenario sobre la higiene de manos.\n\n| Resultado   | Qué afirmar               |  \n| ----------- | ------------------------- |  \n| L ✔️ / Q ✔️ | Tendencia + curvatura     |  \n| L ✔️ / Q ❌  | Tendencia lineal          |  \n| L ❌ / Q ✔️  | Efecto no monótono        |  \n| L ❌ / Q ❌   | Sin asociación detectable |\n\n**Considerando el curso como ORDINAL para cuantificar el efecto tiempo** (no se trata como numérico ya que suponemos que no están igualmente espaciados).\n\n```{r}\nm1 <- glm(accion ~ curso + indicacion + escenario, data = data, family = binomial(link = 'logit'))\ntbl_regression(m1, exponentiate = FALSE)\n```\n\n::: {.callout-note}\nParámetros lineal y cuadrático del factor curso significativos: existe una tendencia global a lo largo de los niveles PERO esa tendencia  no es puramente lineal.  \n- El efecto del ordinal no puede resumirse en un único “por nivel”.  \n- Los cambios entre niveles no son constantes.  \n- Algún nivel intermedio se comporta de forma distinta a lo esperado por una recta.  \n:::\n\n```{r}\n# Modelo con curso como numérico (efecto lineal)\nm_lin <- glm(accion ~ as.numeric(curso) + indicacion + escenario, data = data, family = binomial(link = \"logit\"))\n\n# Modelo con curso como factor (categórico)\nm_fac <- glm(accion ~ factor(curso) + indicacion + escenario, data = data, family = binomial(link = \"logit\"))\n\ncat(\"H0: el efecto de curso es lineal (modelo numérico es suficiente).\\nH1: el efecto no es lineal (modelo categórico ajusta mejor). \")\nlrt <- anova(m_lin, m_fac, test = \"LRT\")\nlrt <- broom::tidy(lrt, conf.int = FALSE)\nlrt <- lrt |> as.data.frame() |> mutate(`p valor` = sapply(p.value, categorizar_p))\nkable(lrt |> select(-p.value), format = \"html\", caption = \"Prueba de razón de verosimilitud (LRT) para evaluar la linealidad del efecto de curso\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\ncat(ifelse(lrt$p.value[2] < 0.05,\n           \"Se rechaza H0 (p < 0.05): el efecto de curso no es lineal y conviene tratarlo como factor.\\n\",\n           \"No hay evidencia para rechazar H0 (p ≥ 0.05): no hay evidencia contra la linealidad del efecto de curso.\\n\"))\n\ncat(\"Visualización del patrón no lineal.\")\nnewdata <- data.frame(\n  curso = sort(unique(data |> pull(curso))),\n  indicacion = levels(data |> pull(indicacion))[1],\n  escenario  = levels(data |> pull(escenario))[1])\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"response\"),\n    p_fac = predict(m_fac, newdata, type = \"response\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Probabilidad predicha por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"topleft\",\n  # inset = c(0, -0),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"link\"),\n    p_fac = predict(m_fac, newdata, type = \"link\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Logit por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"topleft\",\n  # inset = c(0, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n\n# Si los puntos negros siguen aproximadamente una recta: el modelo lineal es razonable.  \n# Si existen saltos, curvatura o patrones: el supuesto lineal falla.  \n# La línea roja es lo que el modelo lineal fuerza a que pase.  \n```\n\n\n::: {.callout-note}\n- Los parámetros lineal y cuadrático del factor curso son significativo.  \n- El test LRT rechaza la hipótesis nula.  \n- La relación entre curso y la probabilidad predicha presenta diferencias por curso.\n\nHay evidencia de una relación no lineal entre el curso y la tasa de cumplimiento de higiene de manos.  \nPor ello, no es apropiado usar odd ratios como medidas de interpretación del efecto, se recomiendo usar las medias marginales estimadas.  \n(*emmeans: \"¿Cuál es el riesgo en cada nivel específico del curso y cómo difieren entre sí?*\")\n:::\n\n```{r}\ncat(\"Medias marginales estimadas (probabilidad).\")\ncomparaciones <- emmeans::emmeans(m1, ~ curso, type = \"response\")\n\nkable(comparaciones, format = \"html\", caption = \"Medias marginales estimadas (probabilidad)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\ncat(\"Comparaciones entre cursos.\")\n# (Tukey, escala log-odds)\ncomparaciones <- emmeans::contrast(emmeans::emmeans(m1, ~ curso), method = \"pairwise\")\ncomparaciones <- as.data.frame(comparaciones)\ncomparaciones$`p valor` <- vapply(comparaciones$p.value, categorizar_p, character(1))\n\nkable(comparaciones |> select(-'p.value'), format = \"html\", caption = \"Comparaciones pareadas entre niveles de curso usando estimaciones marginales\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n\nTip. Si estimate > 0: primer grupo tiene mayor media. Si estimate < 0: segundo grupo tiene mayor media.  \n- **pre vs post-corto**. Diferencia negativa (post-corto > pre): la tasa aumenta a corto plazo pero no es significativo.  \n- **pre vs post-largo**. Diferencia positiva (post-largo < pre): la tasa disminuye a largo plazo pero no es significativo.  \n- **post-corto vs post-largo**. Diferencia positiva (post-largo < post-corto), la tasa disminuye con el tiempo en los cursos post-formación y la disminución sí es significativa.  \n\n\n```{r}\nemm <- emmeans::emmeans(m1, ~ curso)\nemm <- as.data.frame(emm)\nggplot(emm, aes(x = curso, y = emmean)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +\n  geom_line(aes(group = 1), linetype = \"dashed\") +\n  labs(\n    x = \"Nivel de curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Medias estimadas de acción por nivel de curso\",\n    subtitle = \"IC al 95 %\"\n  ) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n```\n\n\n::: {.callout-important}\nSe vuelve a estimar el efecto del curso en la tasa de cumplimiento **solo en el escenario de Consulta**.\n:::\n\n```{r}\nm2 <- glm(accion ~ curso + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = 'logit'))\ntbl_regression(m2, exponentiate = FALSE)\n\n# Modelo con curso como numérico (efecto lineal)\nm_lin <- glm(accion ~ as.numeric(curso) + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = \"logit\"))\n\n# Modelo con curso como factor (categórico)\nm_fac <- glm(accion ~ factor(curso) + indicacion, data = data |> filter(escenario=='Consulta'), family = binomial(link = \"logit\"))\n\ncat(\"H0: el efecto de curso es lineal (modelo numérico es suficiente).\\nH1: el efecto no es lineal (modelo categórico ajusta mejor). \")\nlrt <- anova(m_lin, m_fac, test = \"LRT\")\nlrt <- broom::tidy(lrt, conf.int = FALSE)\nlrt <- lrt |> as.data.frame() |> mutate(`p valor` = sapply(p.value, categorizar_p))\nkable(lrt |> select(-p.value), format = \"html\", caption = \"Prueba de razón de verosimilitud (LRT) para evaluar la linealidad del efecto de curso\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\ncat(ifelse(lrt$p.value[2] < 0.05,\n           \"Se rechaza H0 (p < 0.05): el efecto de curso no es lineal y conviene tratarlo como factor.\\n\",\n           \"No hay evidencia para rechazar H0 (p ≥ 0.05): no hay evidencia contra la linealidad del efecto de curso.\\n\"))\n\ncat(\"Visualización del patrón no lineal.\")\nnewdata <- data.frame(\n  curso = sort(unique(data |> filter(escenario=='Consulta') |> pull(curso))),\n  indicacion = levels(data |> filter(escenario=='Consulta') |> pull(indicacion))[1],\n  escenario  = levels(data |> filter(escenario=='Consulta') |> pull(escenario))[1])\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"response\"),\n    p_fac = predict(m_fac, newdata, type = \"response\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Probabilidad predicha por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"bottomleft\",\n  # inset = c(10, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  xpd = TRUE,\n  cex = 0.5\n)\n\nnewdata <- newdata |> \n  mutate(\n    p_lin = predict(m_lin, newdata, type = \"link\"),\n    p_fac = predict(m_fac, newdata, type = \"link\")\n  )\n\nx_labels <- sapply(newdata$curso, function(x) paste(strwrap(x, width = 15), collapse = \"\\n\"))\nx_idx <- 1:length(newdata$curso)\nplot(newdata$curso, newdata$p_fac,\n     type = \"b\", pch = 16,\n     xaxt = \"n\",  # Desactivar eje x por defecto\n     # ylim = c(0, 1),\n     xlab = \"Curso\", ylab = \"Probabilidad predicha\", main = \"Logit por curso\")\nfor(i in seq_along(x_idx)) {\n  mtext(text = x_labels[i], side = 1, at = x_idx[i], line = 2, cex = 0.8)\n}\nlines(newdata$curso, newdata$p_lin, col = \"red\", lwd = 2)\nlegend(\n  \"bottomleft\",\n  # inset = c(0, -0.2),\n  legend = c(\"Curso como factor\", \"Curso lineal\"),\n  col = c(\"black\", \"red\"),\n  lwd = c(1, 2),\n  pch = c(12, NA),\n  cex = 0.5\n)\n```\n\n\n::: {.callout-note}\n- Los parámetros lineal y cuadrático del factor curso son significativo.  \n- El test LRT rechaza la hipótesis nula.  \n- La relación entre curso y la probabilidad predicha presenta diferencias por curso.\n\nHay evidencia de una relación no lineal entre el curso y la tasa de cumplimiento de higiene de manos.  \nPor ello, no es apropiado usar odd ratios como medidas de interpretación del efecto, se recomiendo usar las medias marginales estimadas.  \n(*emmeans: \"¿Cuál es el riesgo en cada nivel específico del curso y cómo difieren entre sí?*\")\n:::\n\n```{r}\ncat(\"Medias marginales estimadas (probabilidad).\")\ncomparaciones <- emmeans::emmeans(m2, ~ curso, type = \"response\")\n\nkable(comparaciones, format = \"html\", caption = \"Medias marginales estimadas (probabilidad)\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n\ncat(\"Comparaciones entre cursos.\")\n# (Tukey, escala log-odds)\ncomparaciones <- emmeans::contrast(emmeans::emmeans(m2, ~ curso), method = \"pairwise\")\ncomparaciones <- as.data.frame(comparaciones)\ncomparaciones$`p valor` <- vapply(comparaciones$p.value, categorizar_p, character(1))\n\nkable(comparaciones |> select(-'p.value'), format = \"html\", caption = \"Comparaciones pareadas entre niveles de curso usando estimaciones marginales\") |>\n  kable_styling(\n    full_width = FALSE,\n    position = \"left\"\n  )\n```\n\n\nTip. Si estimate > 0: primer grupo tiene mayor media. Si estimate < 0: segundo grupo tiene mayor media.  \n- **pre vs post-corto. Diferencia negativa (post-corto > pre): la tasa aumenta a corto plazo pero no es significativo.  \n- **pre vs post-largo**. Diferencia positiva (post-largo < pre): la tasa disminuye a largo plazo pero no es significativo.  \n- **post-corto vs post-largo**. Diferencia positiva (post-largo < post-corto), la tasa disminuye con el tiempo en los cursos post-formación y la disminución sí es significativa.  \n\n\n```{r}\nemm <- emmeans::emmeans(m2, ~ curso)\nemm <- as.data.frame(emm)\nggplot(emm, aes(x = curso, y = emmean)) +\n  geom_point(size = 3) +\n  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2) +\n  geom_line(aes(group = 1), linetype = \"dashed\") +\n  labs(\n    x = \"Nivel de curso\",\n    y = \"Tasa de cumplimiento\",\n    title = \"Medias estimadas de acción por nivel de curso\",\n    subtitle = \"IC al 95 %\"\n  ) +\n  theme_minimal() +\n  theme(axis.line = element_line(), axis.text.x = element_text(size = 8), panel.grid = element_blank())\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":{"html_document":{"toc-title":"Ingesta de datos","toc":true,"toc_depth":2}},"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","self-contained":true,"toc":true,"css":["../styles.css"],"output-file":"02_estudio_adherencia.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","navbar":{"left":[{"href":"index.html","text":"Inicio"},{"href":"../../00_Documentación/20240830 CRD_HM UFV.pdf","text":"Ingesta de datos"},{"href":"00_main.html","text":"Ingesta de datos"},{"href":"scr/00_main.html","text":"Librerías"}]},"toc-location":"left","toc-width":"100px","toc-expand":true,"page-layout":"full","editor":"visual","knitr":{"opts_chunk":{"code-fold":false,"R.options":{"width":110},"fig.align":"center"}},"theme":{"light":"default","dark":"darkly"},"title":"Adherencia HM en el Centro de Simulación","subtitle":"Tasa de cumplimiento de la higiene de manos","author":[{"name":"Mario Camacho","affiliation":"Facultad de Medicina"},{"name":"Fernando Neria","affiliation":"Facultad de Medicina"}],"date":"2026-01-07","date-modified":"last-modified"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}